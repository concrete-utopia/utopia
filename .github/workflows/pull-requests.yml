name: Pull Request
on: [pull_request]

jobs:
  cache-pnpm-store:
    name: Install everything with PNPM and cache it
    secrets: inherit
    uses: ./.github/workflows/cache-pnpm-install.yml

  build-everything:
    name: Build Everything
    timeout-minutes: 60
    runs-on: ubuntu-latest
    needs: [cache-pnpm-store]
    env:
      UTOPIA_SHA: ${{ github.sha }}
    steps:
      - name: Cancel existing runs on this branch
        uses: fauguste/auto-cancellation-running-action@0.1.4
        with:
          githubToken: ${{ secrets.GITHUB_TOKEN }}
      - name: Check out the repo
        uses: actions/checkout@v2
      - name: Install nix
        uses: cachix/install-nix-action@v12
        with:
          nix_path: nixpkgs=https://github.com/NixOS/nixpkgs/archive/6120ac5cd201f6cb593d1b80e861be0342495be9.tar.gz
      - name: Build it
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: nix-shell --arg includeServerBuildSupport true --arg includeEditorBuildSupport true --arg includeReleaseSupport true --arg includeDatabaseSupport true --arg includeRunLocallySupport false --run build-all-staging
