name: Editor Tests (Sharded)
on:
  workflow_call:
    inputs:
      shard_number:
        required: true
        type: number
      branch:
        required: true
        type: string

jobs:
  test-editor-karma-shard:
    name: Test Editor PR â€“ Karma tests (Shard ${{ inputs.shard_number }})
    runs-on: ubuntu-latest
    env:
      UTOPIA_SHA: ${{ github.sha }}
    steps:
      - name: Cancel existing runs on this branch
        uses: fauguste/auto-cancellation-running-action@0.1.4
        with:
          githubToken: ${{ secrets.GITHUB_TOKEN }}
      - name: Check out the repo
        uses: actions/checkout@v2
      - name: Cache install Nix packages
        uses: rikhuijzer/cache-install@v1.0.9
        with:
          key: nix-${{ hashFiles('*.nix') }}
          nix_file: 'frontend-ci.nix'
      - name: Cache editor test result
        id: cache-editor-tests
        uses: actions/cache@v2
        with:
          # For the tests it doesn't really matter what we cache
          path: editor/lib
          key: ${{ runner.os }}-editor-karma-tests-shard-${{ inputs.shard_number }}-${{ inputs.branch }}-${{ hashFiles('editor/src/**') }}-${{ hashFiles('utopia-api/src/**') }}-${{ hashFiles('editor/package.json') }}-${{ hashFiles('utopia-api/package.json') }}
      - name: Cache .pnpm-store
        uses: actions/cache@v2
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}
      - name: Run the Karma tests
        if: steps.cache-editor-tests.outputs.cache-hit != 'true'
        run: check-editor-karma-ci-shard-${{ inputs.shard_number }}
